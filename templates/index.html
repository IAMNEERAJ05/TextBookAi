<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="/static/images/text-logo.png" />
  <title>VidyAI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/css/index.css" />
  <style>
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      display: none;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
/* 
    .subtopic-link {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }

    .subtopic-link:hover {
      color: #0056b3;
    }

    .chapter-title {
      color: #333;
      font-weight: bold;
    }

    .topic-title {
      color: #555;
    }
      */

    .pdf-link {
      color: #333;
      text-decoration: none;
      font-size: larger;
    } 

    .pdf-link:hover {
      color: #4bc8e4;
    } 
/*
    .topic-link {
      color: #28a745;
      text-decoration: none;
      font-weight: bold;
    }

    .topic-link:hover {
      color: #218838;
    }

    .nested-subtopics {
        margin-left: 20px;
        list-style-type: circle;
    }
    
    .subtopics-list {
        margin-left: 15px;
        list-style-type: disc;
    }
    
    .topic-list {
        list-style-type: none;
    }
    
    .chapter-title {
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .topic-link {
        color: #34495e;
        text-decoration: none;
    }
    
    .subtopic-link {
        color: #7f8c8d;
        text-decoration: none;
    }
    
    .topic-link:hover, .subtopic-link:hover {
        text-decoration: underline;
    } */

    /* details {
        margin-left: 20px;
    }

    summary {
        cursor: pointer;
        margin-bottom: 5px;
    }

    summary:hover {
        color: #4bc8e4;
    } */

    /* .subtopics-list {
        margin-left: 20px;
        list-style-type: none;
    }
    
    .topic-list {
        list-style-type: none;
        padding-left: 0;
    }
    
    .chapter-title {
        display: inline;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .topic-link {
        color: #34495e;
        text-decoration: none;
    }
    
    .subtopic-link {
        color: #7f8c8d;
        text-decoration: none;
    }
    
    .topic-link:hover, .subtopic-link:hover {
        color: #4bc8e4;
        text-decoration: none;
    } */

    /* details > summary {
        list-style: none;
    }
    details > summary::-webkit-details-marker {
        display: none;
    }

    details > summary::before {
        content: '▶';
        margin-right: 5px;
        color: #7f8c8d;
    }
    details[open] > summary::before {
        content: '▼';
    }

    .list-group-item {
        border: none;
        padding: 0.5rem 1rem;
    }

    details {
        margin: 0.5rem 0;
    }

    summary {
        cursor: pointer;
        list-style: none;
        margin-bottom: 0.5rem;
    }

    summary::-webkit-details-marker {
        display: none;
    }

    .topic-link, .subtopic-link {
        color: #007bff;
        text-decoration: none;
    }

    .topic-link:hover, .subtopic-link:hover {
        color: #0056b3;
    }

    .chapter-title {
        color: #333;
    }

    .topic-title {
        color: #555;
    } */
  </style>
</head>

<body>
  <div class="container custom-container mt-5">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h2 brand-name">
        <span class="brand-vidy">Vidy</span><span class="brand-ai">AI</span>
      </h1>
      <div>
        {% if username %}
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
        {% else %}
        <a href="/login" class="btn btn-outline-primary me-2">Login</a>
        {% endif %}
      </div>
    </header>

    {% if username %}
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Welcome, {{ username }}!</h5>
      </div>
    </div>
    {% endif %}

    <!-- Add Tabs for Upload and Library -->
    <ul class="nav nav-tabs" id="pdfTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button"
          role="tab" aria-controls="upload" aria-selected="true">
          Upload PDF
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="library-tab" data-bs-toggle="tab" data-bs-target="#library" type="button"
          role="tab" aria-controls="library" aria-selected="false">
          Library
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="pdfTabsContent">
      <!-- Upload Section -->
      <div class="tab-pane fade show active" id="upload" role="tabpanel" aria-labelledby="upload-tab">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Upload PDF</h5>
            <form action="/upload_pdf/" method="post" enctype="multipart/form-data" id="upload-form">
              <div class="mb-3">
                <input class="form-control" type="file" id="file" name="file" accept="application/pdf" required />
              </div>
              <button type="submit" class="btn btn-primary" id="generateBtn">Generate</button>
              <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none">
                Cancel
              </button>
              <button type="button" class="btn btn-warning" id="regenerateBtn" style="display: none">
                Regenerate
              </button>
            </form>
          </div>
        </div>
        <div id="chaptersContainer" class="mt-4">
          <div class="loader" id="loader" style="display: none"></div>
          <div id="response"></div>
        </div>
      </div>

      <!-- Library Section -->
      <div class="tab-pane fade" id="library" role="tabpanel" aria-labelledby="library-tab">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">My Library</h5>
            {% if username %}
                {% if pdfs %}
                    <ul class="list-group">
                        {% for pdf in pdfs %}
                            <li class="list-group-item">
                                <details>
                                    <summary class="d-flex justify-content-between align-items-center">
                                        <span class="pdf-link">{{ pdf.name }}</span>
                                    </summary>
                                    <div class="mt-3 text-center">
                                        <button class="btn btn-primary me-2" onclick="viewBook('{{ pdf.id }}')">
                                            View Book
                                        </button>
                                        <button class="btn btn-danger" onclick="deletePDF('{{ pdf.id }}')">
                                            Delete
                                        </button>
                                    </div>
                                </details>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No PDFs in your library yet. Upload a PDF to get started!</p>
                {% endif %}
            {% else %}
                <p>Please <a href="/login">login</a> to view your library.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="about-section">
      <details>
        <summary>
            <h2>About VidyAI</h2>
          </summary>
          <div class="content">
            <p>Welcome to VidyAI, your intelligent learning companion!</p>
            <p>
              VidyAI revolutionizes the way you study by transforming your
              textbooks, PDFs, and presentations into an interactive and
              personalized learning experience. Here's how it works:
            </p>
            <ul>
              <li>
                <strong>Content Breakdown:</strong> Upload your study materials,
                and VidyAI will intelligently break them down into chapters,
                topics, and subtopics.
              </li>
              <li>
                <strong>Smart Summaries:</strong> For each subtopic, get access
                to concise summaries or easily readable versions extracted from
                your original content.
              </li>
              <li>
                <strong>Interactive Learning:</strong> Progress through your
                materials at your own pace, ensuring thorough understanding of
                each section.
              </li>
              <li>
                <strong>Chapter Quizzes:</strong> At the end of each chapter,
                test your knowledge with a comprehensive quiz.
              </li>
              <li>
                <strong>Adaptive Progress:</strong> Move on to the next chapter
                only after successfully passing the quiz, ensuring you've
                mastered the current material.
              </li>
            </ul>
            <p>
              With VidyAI, transform your study routine into an efficient,
              engaging, and effective learning journey. Upload your materials
              now and experience the future of personalized education!
            </p>
          </div>
        </details>
      </div>

      <!-- Add this div for bottom spacing -->
      <div class="mb-5"></div>

    <!-- Toast for notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11">
      <div id="uploadToast" class="toast align-items-center text-white bg-danger border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            Failed to upload. Please ensure you are logged in and try again.
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
        </div>
      </div>
    </div>

    <script>
      let abortController = null;
      let contentGenerated = false;

      document.getElementById("upload-form").onsubmit = async function (event) {
        event.preventDefault();
        await generateContent();
      };

      document.getElementById("cancelBtn").onclick = function () {
        if (abortController) {
          abortController.abort();
          document.getElementById("response").innerHTML =
            "Generation cancelled.";
          resetButtons();
        }
      };

      document.getElementById("regenerateBtn").onclick = async function () {
        await generateContent();
      };

      document.getElementById("file").onchange = function () {
        contentGenerated = false;
        resetButtons();
      };

      async function generateContent() {
        const formData = new FormData();
        const fileInput = document.getElementById("file");
        formData.append("file", fileInput.files[0]);

        const responseDiv = document.getElementById("response");
        const loader = document.getElementById("loader");
        const chaptersContainer = document.getElementById("chaptersContainer");

        responseDiv.innerHTML = "";
        loader.style.display = "block";
        chaptersContainer.style.display = "block";

        document.getElementById("generateBtn").style.display = "none";
        document.getElementById("cancelBtn").style.display = "inline-block";
        document.getElementById("regenerateBtn").style.display = "none";

        abortController = new AbortController();

        try {
            const response = await fetch("/upload_pdf/", {
                method: "POST",
                body: formData,
                signal: abortController.signal,
            });

            if (response.ok) {
                const data = await response.json();
                console.log("Server response:", data);

                if (data.error) {
                    responseDiv.innerHTML = data.error;
                    showToast();
                } else if (data.structure && data.structure.chapters) {  // Changed this line
                    let chaptersHTML = '<div class="topics-container"><h2>Book Structure</h2>';
                    chaptersHTML += renderChapters(data.structure.chapters);  // And this line
                    chaptersHTML += "</div>";

                    responseDiv.innerHTML = chaptersHTML;
                    contentGenerated = true;
                } else {
                    console.error("Invalid response format:", data);
                    responseDiv.innerHTML = "Received an unexpected response format from the server.";
                }
            } else {
                throw new Error(`Response not OK: ${response.status} ${response.statusText}`);
            }
        } catch (error) {
            console.error("Error details:", error);
            responseDiv.innerHTML = `An error occurred during upload: ${error.message}`;
            showToast();
        } finally {
            loader.style.display = "none";
            resetButtons();
        }
      }

      function renderSubtopics(subtopics, chapterName, topicName) {
        if (!subtopics || !Array.isArray(subtopics) || subtopics.length === 0) return "";
        
        return subtopics.map(subtopic => {
            // Handle both string and object subtopics
            if (typeof subtopic === 'string') {
                return `<li class="list-group-item">
                    <a href="/subtopic/${encodeURIComponent(chapterName)}/${encodeURIComponent(topicName)}/${encodeURIComponent(subtopic)}" 
                        class="subtopic-link" target="_blank">${subtopic}</a>
                </li>`;
            } else if (typeof subtopic === 'object' && subtopic.name) {
                let subtopicHTML = `
                <li class="list-group-item">
                    <details>
                        <summary>
                            <a href="/subtopic/${encodeURIComponent(chapterName)}/${encodeURIComponent(topicName)}/${encodeURIComponent(subtopic.name)}" 
                                class="subtopic-link" target="_blank">${subtopic.name}</a>
                        </summary>`;
                
                if (subtopic.subtopics && subtopic.subtopics.length > 0) {
                    subtopicHTML += `<ul class="list-group mt-2">
                        ${renderSubtopics(subtopic.subtopics, chapterName, subtopic.name)}
                    </ul>`;
                }
                
                subtopicHTML += `</details></li>`;
                return subtopicHTML;
            }
            return "";
        }).join("");
      }

      function renderTopics(topics, chapterName) {
        if (!Array.isArray(topics)) return "";
        
        return topics.map(topic => {
            let topicHTML = `
            <li class="list-group-item">
                <details>
                    <summary>
                        <strong class="topic-title">
                            <a href="/topic/${encodeURIComponent(chapterName)}/${encodeURIComponent(topic.name)}" 
                                class="topic-link" target="_blank">${topic.name}</a>
                        </strong>
                    </summary>`;

            if (topic.subtopics && topic.subtopics.length > 0) {
                topicHTML += `<ul class="list-group mt-2">
                    ${renderSubtopics(topic.subtopics, chapterName, topic.name)}
                </ul>`;
            }

            topicHTML += `</details></li>`;
            return topicHTML;
        }).join("");
      }

      function renderChapters(chapters) {
        if (!Array.isArray(chapters)) return "";
        
        return chapters.map(chapter => {
            let chapterHTML = `
            <li class="list-group-item">
                <details>
                    <summary>
                        <strong class="chapter-title">${chapter.name}</strong>
                    </summary>
                    
                    <div class="content">`;
            
            if (chapter.topics && Array.isArray(chapter.topics) && chapter.topics.length > 0) {
                chapterHTML += `
                    <ul class="list-group mt-2">
                        ${renderTopics(chapter.topics, chapter.name)}
                    </ul>`;
            }
            
            // Add the Take Quiz button
            chapterHTML += `
                    <button class="btn btn-primary mt-3" onclick="openQuiz('${encodeURIComponent(chapter.name)}')">
                        Take Quiz
                    </button>
                    </div>
                </details>
            </li>`;
            return chapterHTML;
        }).join("");
      }

      function resetButtons() {
        if (contentGenerated) {
          document.getElementById("generateBtn").style.display = "none";
          document.getElementById("regenerateBtn").style.display =
            "inline-block";
        } else {
          document.getElementById("generateBtn").style.display = "inline-block";
          document.getElementById("regenerateBtn").style.display = "none";
        }
        document.getElementById("cancelBtn").style.display = "none";
        abortController = null;
      }

      function showToast() {
        const toastElement = document.getElementById("uploadToast");
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
      }

      function openQuiz(chapter) {
        window.open(`/quiz/${chapter}`, "_blank");
      }

      async function deletePDF(pdfId) {
        if (confirm('Are you sure you want to delete this PDF?')) {
            try {
                const response = await fetch(`/delete_pdf/${pdfId}`, {
                    method: 'DELETE',
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('PDF deleted successfully');
                    location.reload(); // Reload the page to reflect changes
                } else {
                    alert(data.error || 'Failed to delete PDF');
                }
            } catch (error) {
                console.error('Error deleting PDF:', error);
                alert('An error occurred. Please try again.');
            }
        }
      }

      function viewBook(pdfId) {
        window.open(`/book/${pdfId}`, '_blank');
      }

      // Initialize Bootstrap tabs
      document.addEventListener('DOMContentLoaded', function() {
          var triggerTabList = [].slice.call(document.querySelectorAll('#pdfTabs button'))
          triggerTabList.forEach(function(triggerEl) {
              var tabTrigger = new bootstrap.Tab(triggerEl)
              triggerEl.addEventListener('click', function(event) {
                  event.preventDefault()
                  tabTrigger.show()
              })
          })
      });

      
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>